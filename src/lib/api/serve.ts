import { getNodeHandler, startServer } from "edgespec/adapters/node"
import { bundle } from "./index.js"
import https from "node:https"

export const serve = async (port: number) => {
  const server = await startServer(bundle, {
    port,
  })

  return server
}

export const TEST_CERT = `
-----BEGIN CERTIFICATE-----
MIIDfzCCAmegAwIBAgIEGwGErjANBgkqhkiG9w0BAQsFADBbMScwJQYDVQQDDB5SZWdlcnkgU2Vs
Zi1TaWduZWQgQ2VydGlmaWNhdGUxIzAhBgNVBAoMGlJlZ2VyeSwgaHR0cHM6Ly9yZWdlcnkuY29t
MQswCQYDVQQGEwJVQTAgFw0yNDA4MjMwMDAwMDBaGA8yMTI0MDgyMzAwNTAxOVowQTENMAsGA1UE
AwwEdGVzdDEjMCEGA1UECgwaUmVnZXJ5LCBodHRwczovL3JlZ2VyeS5jb20xCzAJBgNVBAYTAlVB
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA9vHYbSZfFE6Cbgf0vwp5raxQYA+oQban
V/rwHweKUWYfcNyqc4pbDWcCG6qfpcIn4DeeNeGsR9dL26TVuJqQf8UP9K7+UkrBTFupv2I47pWz
+TFh5A71Z3vjBycZRAZ6HLKnIPWPinsC0qlv2x+VlDGujro5JeU5p8fQW2a2Sdbi80rM7J1qNxlf
ajA1FCiiRVbs1TvkPtj5N2BAGcDFCnD99to2++TSzXk5PflwliUnZRWo1jb55rN9+j3BCtqPYjV2
mkFpCOkK3cX8RADFfOg8R/GuYRHxXbIjaWCDPKyr76ExTGjm76qfRvoWJqEtMgTLAfkdl4ntVyuW
BR/TBQIDAQABo2MwYTAPBgNVHRMBAf8EBTADAQH/MA4GA1UdDwEB/wQEAwIBhjAdBgNVHQ4EFgQU
78b032SnKNcyz8GRKi5JOqEtZ78wHwYDVR0jBBgwFoAU78b032SnKNcyz8GRKi5JOqEtZ78wDQYJ
KoZIhvcNAQELBQADggEBADBLDjnKu38vgQ+jaqS1hcTiv4Qcp+WJnytXhgoJyUTh9RUCm9RPT0dV
eyml+OKj/GJzyFAF/4cCpEIvixyxLC97NpQfm1aR7el3jccrku+bo8WOjzxn2lVGf29NJ+QL5kBj
O511ragZj54OMtPo1ZENl5hTaN1WvAC/aCT+c0VPsURZsbDU1ODqohjrWP4kkCBL/JI3kKSjBIqP
Gy22da9o3r/xSfjAD9HQAFHuutEWT0rCeyCtCf7Zg355n9QiD33TVHu+ehcJEQ4NLbMmVFqDhvkz
VkSnrT6C9q6OjvJvJ1f3yg6zmq0zmXOBZSp81pf6HneOxzCD623NQRuOZLA=
-----END CERTIFICATE-----
`.trim()

export const TEST_PK = `
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA9vHYbSZfFE6Cbgf0vwp5raxQYA+oQbanV/rwHweKUWYfcNyq
c4pbDWcCG6qfpcIn4DeeNeGsR9dL26TVuJqQf8UP9K7+UkrBTFupv2I47pWz+TFh
5A71Z3vjBycZRAZ6HLKnIPWPinsC0qlv2x+VlDGujro5JeU5p8fQW2a2Sdbi80rM
7J1qNxlfajA1FCiiRVbs1TvkPtj5N2BAGcDFCnD99to2++TSzXk5PflwliUnZRWo
1jb55rN9+j3BCtqPYjV2mkFpCOkK3cX8RADFfOg8R/GuYRHxXbIjaWCDPKyr76Ex
TGjm76qfRvoWJqEtMgTLAfkdl4ntVyuWBR/TBQIDAQABAoIBABojR5HoB5TN6YrN
b0egS3hJPpmoVpocA/LxReS25tpOSaInzSfdG12cC1JT2UGRfyiBoo6X9CUHggk9
1XxMaeKIQHPY6OTbckHLivhNpHKGaG4GHtMljS6Wo5VQe2FioR6z/zIjI74X3pjf
I86I9YthxdToG5/p9xQN930RLla6wYErF0qkRuAv+H0jx72YI4yJHZCOqywjt2y3
Qa9PkSR8ANj2G1g8Kq5IKncP3Mok8r54I/7mJwilp7irRZj24cHRDys6Bmz9QIDx
GPS+2QthxwOLzWqnOx7pb+HiND+/vJwk1Y9bjLF3IyvuO39wCyQanftFH6dBvOG2
H+P2v7ECgYEA/PkCXG/Fzrx9gvKCCI430w6fMxMuOf9jz6zd+/nt517KrrLiioqW
WgLAT7iUIB/P799jKNUW7hpnC4YhJT/qDNREhh2spzHLmJAa8csWM26J3x/5QqkW
qXLyc11IfwfH4UEX5OhB3FCGrPj5ORn8UmZKKroMeDv9V1MTeu1+w9ECgYEA+eZe
h0lK8/NUlQZYQShdEIwjH9b9ANMZiyN2tZX+OxpB6CePxmk5VBUn6bmRMx9iqeJj
XjUQN2Peh91pL4OokKBYVDiFdFlFotzymBKttCN3YUlpurl2J6XKNDXUfnloffX+
15k+0MqHQwEDmzbJrs8YpbqE+UPqZKOdhcDerPUCgYAdYOHIUGa9gqBk47r8OV/8
T9dnPBQDQkiaJq5FBBp/4z9QmI+8nSmm3GjvGTWCoY8pgVznsg+OqVxMN1CEHe8V
fFVU6f9SD3NgjWPDrt0uLekvE2yENFTgauwDP9MahZHN9BxNRjfX2TY6wlNXMVBf
VWfJnH+0OutKB+jcPtaY8QKBgCvaxqn9Lb8j66r/YwuENtjJjvxucRXs9eWaAqIZ
QXVDxV8lWjDalGnyEIAOxbFwB5OCnCeTLlZaG1pCe8wP0cwXp4iYJqtlYzgSiCwx
0vPy6WdUR86x709D4/lHnRPY4IKCYgeZ6BEiCZyzl9tsQPaBd3TWB7Hqvj6NC/7F
+w3lAoGBANEjfIo36UkPx+SGB6CulkKA9dCmNLQ2M3dOHBUuId04vn/YHrUJxH/w
DdZqRg9IkpehFG8eUW6taG/UmIe4JObWrUBfEH4kv3VaV5tT41q/76LcEnS0USVi
dS/vQnmDWJw3sB3m2r/iE1P8Avr+XlaLBGRARq5K+l09vb4fOjFK
-----END RSA PRIVATE KEY-----
`.trim()

export const serveHTTPS = async (port: number) => {
  const handler = getNodeHandler(bundle, {})
  const server = https
    .createServer(
      {
        key: TEST_PK,
        cert: TEST_CERT,
      },
      handler,
    )
    .listen(port)
  return server
}
